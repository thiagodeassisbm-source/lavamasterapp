// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// MULTI-TENANT MODELS
// ============================================

// Empresa/Cliente do Sistema SaaS
model Empresa {
  id            String   @id @default(uuid())
  nome          String
  cnpj          String   @unique
  email         String
  telefone      String?
  endereco      String?
  cidade        String?
  estado        String?
  cep           String?
  logo          String?
  
  // Controle de Acesso e Plano
  ativo         Boolean  @default(true)
  bloqueado     Boolean  @default(false)
  motivoBloqueio String?
  plano         String   @default("basico") // Nome display do plano
  planoId       String?  // Relacionamento oficial
  valorMensal   Float    @default(0)
  dataContratacao DateTime @default(now())
  dataExpiracao DateTime?
  proximoVencimento DateTime?
  
  // Limites por Plano
  limiteUsuarios    Int @default(5)
  limiteClientes    Int @default(100)
  limiteAgendamentos Int @default(1000)
  
  // Observações internas
  observacoesInternas String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relações
  planoRel      Plano?   @relation(fields: [planoId], references: [id])
  usuarios      Usuario[]
  clientes      Cliente[]
  agendamentos  Agendamento[]
  servicos      Servico[]
  produtos      Produto[]
  vendas        Venda[]
  despesas      Despesa[]
  receitas      Receita[]
  estoque       MovimentacaoEstoque[]
  orcamentos    Orcamento[]

  mensagemConfirmacaoAgendamento String?
  
  @@map("empresas")
}

model Usuario {
  id        String   @id @default(uuid())
  empresaId String?
  nome      String
  email     String
  senha     String
  role      String   @default("usuario") // admin, gerente, usuario
  ativo     Boolean  @default(true)
  avatar    String?
  telefone  String?
  bio       String?
  failedLoginAttempts Int      @default(0) // Segurança: tentativas falhas
  lockoutUntil        DateTime?             // Segurança: bloqueio temporario
  resetToken          String?               // Recuperação de senha
  resetTokenExpires   DateTime?             // Validade do token
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  empresa       Empresa?       @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  agendamentos  Agendamento[]
  vendas        Venda[]

  @@unique([empresaId, email])
  @@index([empresaId])
  @@map("usuarios")
}

// ============================================
// CLIENTES
// ============================================

model Cliente {
  id        String   @id @default(uuid())
  empresaId String
  nome      String
  cpf       String?
  telefone  String
  email     String?
  endereco  String?
  cidade    String?
  estado    String?
  cep       String?
  dataNascimento DateTime?
  observacoes    String?
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  empresa       Empresa        @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  agendamentos  Agendamento[]
  vendas        Venda[]
  orcamentos    Orcamento[]
  veiculos      Veiculo[]

  @@unique([empresaId, cpf])
  @@index([empresaId])
  @@map("clientes")
}

model Veiculo {
  id        String   @id @default(uuid())
  clienteId String
  marca     String
  modelo    String
  ano       Int?
  placa     String?
  cor       String?
  observacoes String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  cliente      Cliente       @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  agendamentos Agendamento[]

  @@index([clienteId])
  @@map("veiculos")
}

// ============================================
// AGENDAMENTOS
// ============================================

model Agendamento {
  id          String   @id @default(uuid())
  empresaId   String
  clienteId   String
  veiculoId   String?
  usuarioId   String?
  dataHora    DateTime
  status      String   @default("agendado") // agendado, confirmado, em_andamento, concluido, cancelado
  observacoes String?
  valorTotal  Float    @default(0)
  desconto    Float    @default(0)
  formaPagamento String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relações
  empresa   Empresa            @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  cliente   Cliente            @relation(fields: [clienteId], references: [id])
  veiculo   Veiculo?           @relation(fields: [veiculoId], references: [id])
  usuario   Usuario?           @relation(fields: [usuarioId], references: [id])
  servicos  AgendamentoServico[]

  @@index([empresaId])
  @@index([dataHora])
  @@index([clienteId])
  @@map("agendamentos")
}

model AgendamentoServico {
  id            String   @id @default(uuid())
  agendamentoId String
  servicoId     String
  quantidade    Int      @default(1)
  valorUnitario Float
  valorTotal    Float
  createdAt     DateTime @default(now())

  // Relações
  agendamento Agendamento @relation(fields: [agendamentoId], references: [id], onDelete: Cascade)
  servico     Servico     @relation(fields: [servicoId], references: [id])

  @@map("agendamentos_servicos")
}

// ============================================
// SERVIÇOS E PRODUTOS
// ============================================

model Servico {
  id          String   @id @default(uuid())
  empresaId   String
  nome        String
  descricao   String?
  preco       Float
  duracao     Int?     // em minutos
  ativo       Boolean  @default(true)
  categoria   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relações
  empresa              Empresa              @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  agendamentos         AgendamentoServico[]
  itensVenda           ItemVenda[]
  itensOrcamento       ItemOrcamento[]

  @@index([empresaId])
  @@map("servicos")
}

model Produto {
  id          String   @id @default(uuid())
  empresaId   String
  nome        String
  descricao   String?
  codigo      String?
  preco       Float
  custo       Float    @default(0)
  estoque     Int      @default(0)
  estoqueMin  Int      @default(0)
  unidade     String   @default("UN") // UN, KG, L, M, etc
  categoria   String?
  ativo       Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relações
  empresa         Empresa               @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  movimentacoes   MovimentacaoEstoque[]
  itensVenda      ItemVenda[]
  itensOrcamento  ItemOrcamento[]

  @@unique([empresaId, codigo])
  @@index([empresaId])
  @@map("produtos")
}

model MovimentacaoEstoque {
  id         String   @id @default(uuid())
  empresaId  String
  produtoId  String
  tipo       String   // entrada, saida
  quantidade Int
  motivo     String?
  createdAt  DateTime @default(now())

  // Relações
  empresa Empresa @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  produto Produto @relation(fields: [produtoId], references: [id])

  @@map("movimentacoes_estoque")
}

// ============================================
// VENDAS E ORÇAMENTOS
// ============================================

model Venda {
  id            String   @id @default(uuid())
  empresaId     String
  clienteId     String
  usuarioId     String?
  dataVenda     DateTime @default(now())
  valorTotal    Float
  desconto      Float    @default(0)
  valorFinal    Float
  formaPagamento String
  status        String   @default("pago") // pago, pendente, cancelado
  observacoes   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relações
  empresa Empresa     @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  cliente Cliente     @relation(fields: [clienteId], references: [id])
  usuario Usuario?    @relation(fields: [usuarioId], references: [id])
  itens   ItemVenda[]

  @@index([empresaId])
  @@index([clienteId])
  @@map("vendas")
}

model ItemVenda {
  id            String   @id @default(uuid())
  vendaId       String
  produtoId     String?
  servicoId     String?
  descricao     String
  quantidade    Int
  valorUnitario Float
  valorTotal    Float
  createdAt     DateTime @default(now())

  // Relações
  venda   Venda    @relation(fields: [vendaId], references: [id], onDelete: Cascade)
  produto Produto? @relation(fields: [produtoId], references: [id])
  servico Servico? @relation(fields: [servicoId], references: [id])

  @@map("itens_venda")
}

model Orcamento {
  id          String   @id @default(uuid())
  empresaId   String
  clienteId   String
  dataOrcamento DateTime @default(now())
  validade    DateTime
  valorTotal  Float
  desconto    Float    @default(0)
  valorFinal  Float
  status      String   @default("pendente") // pendente, aprovado, rejeitado, expirado
  observacoes String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relações
  empresa Empresa         @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  cliente Cliente         @relation(fields: [clienteId], references: [id])
  itens   ItemOrcamento[]

  @@index([empresaId])
  @@index([clienteId])
  @@map("orcamentos")
}

model ItemOrcamento {
  id            String   @id @default(uuid())
  orcamentoId   String
  produtoId     String?
  servicoId     String?
  descricao     String
  quantidade    Int
  valorUnitario Float
  valorTotal    Float
  createdAt     DateTime @default(now())

  // Relações
  orcamento Orcamento @relation(fields: [orcamentoId], references: [id], onDelete: Cascade)
  produto   Produto?  @relation(fields: [produtoId], references: [id])
  servico   Servico?  @relation(fields: [servicoId], references: [id])

  @@map("itens_orcamento")
}

// ============================================
// FINANCEIRO
// ============================================

model Despesa {
  id          String   @id @default(uuid())
  empresaId   String
  descricao   String
  valor       Float
  categoria   String
  dataVencimento DateTime
  dataPagamento  DateTime?
  status      String   @default("pendente") // pendente, pago, vencido
  observacoes String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relações
  empresa Empresa @relation(fields: [empresaId], references: [id], onDelete: Cascade)

  @@index([empresaId])
  @@index([dataVencimento])
  @@map("despesas")
}

model Receita {
  id          String   @id @default(uuid())
  empresaId   String
  descricao   String
  valor       Float
  categoria   String
  dataRecebimento DateTime
  status      String   @default("recebido")
  observacoes String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relações
  empresa Empresa @relation(fields: [empresaId], references: [id], onDelete: Cascade)

  @@index([empresaId])
  @@index([dataRecebimento])
  @@map("receitas")
}

// ============================================
// PLANOS DE ASSINATURA
// ============================================

model Plano {
  id                 String   @id @default(uuid())
  nome               String
  descricao          String?
  preco              Float    @default(0)
  intervalo          String   // MENSAL, TRIMESTRAL, SEMESTRAL, ANUAL, PERSONALIZADO
  duracaoDias        Int?     // Usado se intervalo for PERSONALIZADO
  
  // Limites
  limiteUsuarios     Int      @default(1)
  limiteClientes     Int      @default(100)
  limiteAgendamentos Int      @default(1000)
  
  ativo              Boolean  @default(true)
  destaque           Boolean  @default(false)
  ordem              Int      @default(0)
  
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  
  empresas           Empresa[]

  @@map("planos")
}
